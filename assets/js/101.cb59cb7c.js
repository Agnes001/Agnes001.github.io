(window.webpackJsonp=window.webpackJsonp||[]).push([[101],{493:function(s,a,t){"use strict";t.r(a);var e=t(46),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("https://www.cnblogs.com/along21/p/8011596.html")]),s._v(" "),t("h2",{attrs:{id:"主从复制工作原理剖析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从复制工作原理剖析"}},[s._v("#")]),s._v(" 主从复制工作原理剖析")]),s._v(" "),t("p",[s._v("1.Master 数据库只要发生变化，立马记录到Binary log 日志文件中\n2.Slave数据库启动一个I/O thread连接Master数据库，请求Master变化的二进制日志\n3.Slave I/O获取到的二进制日志，保存到自己的Relay log 日志文件中。\n4.Slave 有一个 SQL thread定时检查Realy log是否变化，变化那么就更新数据")]),s._v(" "),t("h2",{attrs:{id:"为什么要用mysql-的主从"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么要用mysql-的主从"}},[s._v("#")]),s._v(" 为什么要用mysql 的主从")]),s._v(" "),t("p",[s._v("1.实现服务器负载均衡\n在主服务器和从服务器之间切分处理客户查询的负荷，从而得到更好的客户相应时间。通常情况下，数据库管理员会有两种思路。")]),s._v(" "),t("p",[s._v("一是在主服务器上只实现数据的更新操作。包括数据记录的更新、删除、新建等等作业。而不关心数据的查询作业。数据库管理员将数据的查询请求全部 转发到从服务器中。")]),s._v(" "),t("p",[s._v("二是在主服务器上与从服务器切分查询的作业。在这种思路下，主服务器不单单要完成数据的更新、删除、插入等作业，同时也需要负担一部分查询作业。而从服务器的话，只负责数据的查询。当主服务器比较忙时，部分查询请求会自动发送到从服务器重，以降低主服务器的工作负荷。")]),s._v(" "),t("p",[s._v("2.通过复制实现数据的异地备份\n可以定期的将数据从主服务器上复制到从服务器上，这无疑是实现了数据的异地备份。在传统的备份体制下，是将数据备份在本地。此时备份 作业与数据库服务器运行在同一台设备上，当备份作业运行时就会影响到服务器的正常运行。有时候会明显的降低服务器的性能。同时，将备份数据存放在本地，也不是很安全。如硬盘因为电压等原因被损坏或者服务器被失窃，此时由于备份文件仍然存放在硬盘上，数据库管理员无法使用备份文件来恢复数据。这显然会给企业带来比较大的损失。")]),s._v(" "),t("p",[s._v("3.提高数据库系统的可用性")]),s._v(" "),t("p",[s._v("数据库复制功能实现了主服务器与从服务器之间数据的同步，增加了数据库系统的可用性。当主服务器出现问题时，数据库管理员可以马上让从服务器作为主服务器，用来数据的更新与查询服务。然后回过头来再仔细的检查主服务器的问题。此时一般数据库管理员也会采用两种手段。")]),s._v(" "),t("p",[s._v("一是主服务器故障之后，虽然从服务器取代了主服务器的位置，但是对于主服务器可以采取的操作仍然做了一些限制。如仍然只能够进行数据的查询，而不能够进行数据的更新、删除等操作。这主要是从数据的安全性考虑。如现在一些银行系统的升级，在升级的过程中，只能够查询余额而不能够取钱。这是同样的道 理。")]),s._v(" "),t("p",[s._v("二是从服务器真正变成了主服务器。当从服务器切换为主服务器之后，其地位完全与原先的主服务器相同。此时可以实现对数据的查询、更新、删除等操作。为此就需要做好数据的安全性工作。即数据的安全策略，要与原先的主服务器完全相同。否则的话，就可能会留下一定的安全隐患")]),s._v(" "),t("h2",{attrs:{id:"怎么配置mysql主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么配置mysql主从复制"}},[s._v("#")]),s._v(" 怎么配置mysql主从复制")]),s._v(" "),t("p",[s._v("① 环境准备\n本地安装两个mysql，或者使用虚拟机，或者使用docker安装，需要准备两个mysql，本文使用docker安装，具体安装方法详见\nhttps://www.jianshu.com/p/10769f985516")]),s._v(" "),t("p",[s._v("环境\n宿主机 centos7\nmysql:5.6\nmysql1(master): 172.17.0.3:3307\nmysql2(slave): 172.17.0.2:3308")]),s._v(" "),t("p",[s._v("② mysql 配置文件配置\nmysql1(master): 172.17.0.3 my.cnf 配置文件设置，mysql")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql master1 config ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nserver-id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点ID，确保唯一")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log config")]),s._v("\nlog-bin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysql-bin     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启mysql的binlog日志功能")]),s._v("\nsync_binlog "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#控制数据库的binlog刷到磁盘上去 , 0 不控制，性能最好，1每次事物提交都会刷到日志文件中，性能最差，最安全")]),s._v("\nbinlog_format "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mixed   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#binlog日志格式，mysql默认采用statement，建议使用mixed")]),s._v("\nexpire_logs_days "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#binlog过期清理时间")]),s._v("\nmax_binlog_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 100m                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#binlog每个日志文件大小")]),s._v("\nbinlog_cache_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 4m                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#binlog缓存大小")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_binlog_cache_size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 512m              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#最大binlog缓存大")]),s._v("\nbinlog-ignore-db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#不生成日志文件的数据库，多个忽略数据库可以用逗号拼接，或者 复制这句话，写多行")]),s._v("\n\nauto-increment-offset "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自增值的偏移量")]),s._v("\nauto-increment-increment "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自增值的自增量")]),s._v("\nslave-skip-errors "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" all "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#跳过从库错误")]),s._v("\n")])])]),t("p",[s._v("mysql2(slave): 172.17.0.2 mysql.cnf 配置")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nserver-id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nlog-bin"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql-bin\nrelay-log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysql-relay-bin\nreplicate-wild-ignore-table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql.%\nreplicate-wild-ignore-table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("test.%\nreplicate-wild-ignore-table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("information_schema.%\n")])])]),t("p",[s._v("重启两个mysql，让配置生效")]),s._v(" "),t("p",[s._v("③ master数据库，创建复制用户并授权\n1.进入master的数据库，为master创建复制用户")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("CREATE USER repl_user IDENTIFIED BY 'repl_passwd';\n")])])]),t("p",[s._v("2.赋予该用户复制的权利")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("grant replication slave on *.* to 'repl_user'@'172.17.0.2'  identified by 'repl_passwd';\n\nFLUSH PRIVILEGES;\n")])])]),t("p",[s._v("3.查看master的状态")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("show master status;\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000005      120|              | mysql            |                   |\n+------------------+----------+--------------+------------------+-------------------+\n\n1 row in set (0.00 sec)\n")])])]),t("p",[s._v("4,配置从库")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> CHANGE MASTER TO \nMASTER_HOST = '172.17.0.3',  \nMASTER_USER = 'repl_user', \nMASTER_PASSWORD = 'repl_passwd',\nMASTER_PORT = 3307,\nMASTER_LOG_FILE='mysql-bin.000005',\nMASTER_LOG_POS=120,\nMASTER_RETRY_COUNT = 60,\nMASTER_HEARTBEAT_PERIOD = 10000; \n\n# MASTER_LOG_FILE='mysql-bin.000005',#与主库File 保持一致\n# MASTER_LOG_POS=120 , #与主库Position 保持一致\n")])])]),t("p",[s._v("启动从库slave进程")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> slave start;\nQuery OK, 0 rows affected (0.04 sec)\n")])])]),t("p",[s._v("查看是否配置成功")])])}),[],!1,null,null,null);a.default=n.exports}}]);